<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NN Visualization</title>
    <!--<editor-fold desc="this section is for materialize">-->
    <link href="lib/materialize/materialize.min.css" rel="stylesheet">
    <script src="lib/materialize/materialize.min.js"></script>
    <link href="lib/materialize/MaterialIcns.css" rel="stylesheet" type="text/css">
    <style>
        @import "css/playground.css";
    </style>
    <!--</editor-fold>-->
    <!--<editor-fold desc="this section is for tfjs">-->
    <script src="lib/tfjs/tfjs.js"></script>
    <script src="lib/tfjs/tfjs-vis.js"></script>
    <!--</editor-fold>-->

    <!--<editor-fold desc="this section is for other libraries">-->
    <script src="lib/d3.js"></script>
    <script src="lib/tf.min.js"></script>
    <!--</editor-fold>-->
</head>
<body>
<header>
    <h1 class="page"><a href="index.html"><b>Neural Network</b></a> <span class="optional">Exploration Page</span>.</h1>
</header>
<div id="top-controls">
    <div class="container page">
        <div class="control">
            <label for="engineSelection">Select an engine</label>
            <div class="select">
                <select class="select multiple" id="engineSelection" onchange="changeEngine(this);"></select>
            </div>
        </div>
    </div>
</div>
<div class="page" id="main-part">
    <div class="row" style="width: 1400px; margin-left: auto; margin-right: auto;">
        <div class="col s4">
            <div id="inputDiv"></div>
        </div>
        <div class="col s4">
            <div id="modelDiv"></div>
        </div>
        <div class="col s4">
            <div id="layerOutput"></div>
        </div>
    </div>
</div>
<div class="more">
    <a href="#scagStages">

        <button class="mdl-button mdl-js-button mdl-button--fab" data-upgraded="MaterialButton">
            <i class="material-icons">keyboard_arrow_down</i>
        </button>
    </a>
</div>
<article id="article-text">
    <div class="page">
        <h5><a name="scagStages">Computation stages</a></h5>
        <div id="controlButtons"></div>
    </div>
</article>

<script>

    const numberOfEngines = 100;
    const selectedSensors = [2, 3, 4, 6, 7, 8, 9, 11, 12, 13, 14, 15, 17, 20, 21];
    const sequenceLength = 200;
    const numberOfSensors = selectedSensors.length;
    let test_FD = null;
    let test_RUL = null;
    const modelPaths = ['data/models/model.json'];
    let models = [];
    let visModels = [];


    async function main() {
        //Load data
        test_FD = await d3.json('data/test_FD001.json');
        test_RUL = await d3.json('data/test_RUL_FD001.json');
        //Load models
        models = await Promise.all(modelPaths.map(thePath =>tf.loadLayersModel(thePath)));
        //Get the vis model
        visModels = models.map(model=>getVisModel(model));
    }

    main().then(()=>{
        //Populate engine ids.
        populateEngineIds(numberOfEngines);
        drawModels(models);
        //Change to default engine (engine 1)
        changeEngine(document.getElementById('engineSelection'));
    });

    function changeEngine(engineSelection){
        const engineIdx = engineSelection.selectedIndex;
        const engineData = test_FD[engineIdx];
        drawInputs(engineData);
        //Create tensor for the engineData
        const tsEngineX = tf.tensor3d([engineData], [1, sequenceLength, numberOfSensors]);
        //Get output layers for all models.
        const modelLayerOutputs = visModels.map(viz_model=>{
            const layerOutputs = viz_model.predict(tsEngineX);
            return layerOutputs;
        });
        //Draw
        const layerIdx = 1;
        const modelIdx = 0;
        drawLayerOutput(modelLayerOutputs[modelIdx][layerIdx], document.getElementById('layerOutput'));
    }
    function drawLayerOutput(layerOutput, theDiv){
        const heatmapData = {
            values: layerOutput.reshape([layerOutput.shape[1], layerOutput.shape[2]])
        };
        tfvis.render.heatmap(theDiv, heatmapData, {height: 250});
    }
    function populateEngineIds(numberOfEngines){
        const engineSelection = d3.select("#engineSelection");
        for (let i = 0; i < numberOfEngines; i++) {
            engineSelection.append("option").attr("value", i).node().innerHTML = "Engine " + (i+1);
        }
    }
    function drawModels(models) {
        //Create divs for the models
        d3.select('#modelDiv').selectAll('div').data(models).enter().append("div").attr("id", (d, i) => 'model' + i);
        //Draw models
        models.forEach((model, i) => {
            //Show model
            tfvis.show.modelSummary(document.getElementById('model' + i), model);
        });
    }
    function drawInputs(engineData) {
        const inputValues = [];
        const inputSeries = [];
        for (let sensorIdx = 0; sensorIdx < numberOfSensors; sensorIdx++) {
            inputSeries.push('sensor' + selectedSensors[sensorIdx]);
            let sensorValues = [];
            for (let sequenceIdx = 0; sequenceIdx < sequenceLength; sequenceIdx++) {
                sensorValues.push({x: sequenceIdx, y: engineData[sequenceIdx][sensorIdx]})
            }
            inputValues.push(sensorValues);
        }
        //Add the divs for inputs
        d3.select("#inputDiv").selectAll(".inputSensor").data(selectedSensors).enter().append("div").attr("id", (d, i) => "inputSensor" + d);
        //Draw inputs
        for (let i = 0; i < selectedSensors.length; i++) {
            tfvis.render.linechart(document.getElementById("inputSensor" + selectedSensors[i]), {
                values: inputValues[i],
                series: ['sensor' + selectedSensors[i]]
            }, {width: 400, height: 100, xLabel: 'sequence step', yLabel: 'sensor value'});
        }
    }
    function getVisModel(model) {
        const output_layers = model.layers.map(l => l.output);
        const input = model.input;
        const viz_model = tf.model({inputs: input, outputs: output_layers});
        return viz_model
    }


</script>

</body>
</html>